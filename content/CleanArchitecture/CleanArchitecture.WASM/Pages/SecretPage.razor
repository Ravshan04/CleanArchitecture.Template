@page "/SecretPage"
@using CleanArchitecture.WASM.Auth
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IHttpClientFactory HttpClientFactory
@inject IAuthService AuthService
<h3>SecretPage</h3>

<button @onclick="CallApi">Call Protected API</button>

@if (!string.IsNullOrEmpty(message))
{
    <p>@message</p>
}

@if (!string.IsNullOrEmpty(error))
{
    <p style="color:red">@error</p>
}

@code {
    private string? message;
    private string? error;

    private async Task CallApi()
    {
        message = null;
        error = null;

        try
        {
            var httpClient = HttpClientFactory.CreateClient("Api");
            var response = await httpClient.GetAsync("api/auth/test");

            if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                // Пробуем обновить токен
                var refreshed = await AuthService.TryRefreshTokenAsync();
                if (refreshed)
                {
                    response = await httpClient.GetAsync("api/auth/test");
                }
            }

            if (response.IsSuccessStatusCode)
            {
                message = await response.Content.ReadAsStringAsync();
            }
            else
            {
                error = $"API call failed: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            error = $"Exception: {ex.Message}";
        }
    }
}